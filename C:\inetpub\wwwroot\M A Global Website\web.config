<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <handlers>
            <add name="iisnode" path="server.js" verb="*" modules="iisnode"/>
        </handlers>
        
        <rewrite>
            <rules>
                <!--
                  Rule 1: Serve Static Files
                  Checks if the request is for a real file on the disk (e.g., in .next/static or public/).
                  If it is, IIS serves it directly and stops processing other rules.
                -->
                <rule name="ServeStaticFiles" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                    </conditions>
                    <action type="None" />
                </rule>

                <!--
                  Rule 2: Handle Dynamic Content (Next.js Pages)
                  If the request was not for a static file, this rule passes it to server.js
                  for Next.js to render the appropriate page.
                -->
                <rule name="DynamicContent">
                    <match url=".*" />
                    <action type="Rewrite" url="server.js" />
                </rule>
            </rules>
        </rewrite>
        
        <!-- iisnode settings -->
        <iisnode watchedFiles="web.config;*.js"
                 node_env="production"
                 loggingEnabled="true"
                 devErrorsEnabled="true" />
                 
    </system.webServer>
</configuration>
