<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- Rule 1: Let iisnode handle its own internal requests (e.g., for debugging). -->
        <rule name="iisnode-internals" stopProcessing="true">
            <match url="^server.js\/debug" />
        </rule>
        
        <!-- Rule 2: If the request is for a real, physical file, serve it directly. -->
        <!-- This handles all static assets (.css, .js, .png, .svg, etc.) from the .next and public folders. -->
        <rule name="Static-Files" stopProcessing="true">
            <match url=".*" />
            <conditions logicalGrouping="MatchAll">
                <add input="{REQUEST_FILENAME}" matchType="IsFile" />
            </conditions>
        </rule>
        
        <!-- Rule 3: For all other requests, send them to the Next.js application. -->
        <!-- This handles all page routes like /, /about, /contact, etc. -->
        <rule name="Next-App-Router">
            <match url=".*" />
            <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!-- Enable detailed error logging for diagnostics. -->
    <iisnode loggingEnabled="true" devErrorsEnabled="true" />

    <!-- Security: Block access to the node_modules folder from the web. -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="node_modules" />
        </hiddenSegments>
      </requestFiltering>
    </security>

  </system.webServer>
</configuration>
