
<configuration>
  <system.webServer>

    <!-- Hides node_modules and iisnode directories from being served -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="node_modules" />
          <add segment="iisnode" />
        </hiddenSegments>
      </requestFiltering>
    </security>

    <!-- Configures iisnode module -->
    <iisnode
      node_env="production"
      loggingEnabled="true"
      devErrorsEnabled="false"
      watchedFiles="web.config;server.js;*.json"
    />

    <!-- Designates server.js as the entry point -->
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!--
          This is the most important rule. It stops processing for any request that
          maps to a physical file on the server. This allows IIS to
          serve static assets (CSS, JS, images) directly without sending the
          request to the Node.js application.
        -->
        <rule name="StaticFile" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!--
          This rule rewrites all other requests (i.e., for pages that don't
          exist as physical files) to the server.js file, so that the Next.js
          application can handle the routing and render the correct page.
        -->
        <rule name="NextJsRoutes">
          <match url=".*" />
          <action type="Rewrite" url="server.js" />
        </rule>
      </rules>
    </rewrite>

    <!--
        This setting is required for iisnode to work correctly.
        It ensures that the default document handling of IIS does not
        interfere with the Node.js application.
    -->
    <defaultDocument enabled="false" />

  </system.webServer>
</configuration>
